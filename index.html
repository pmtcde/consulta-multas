<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Multas - PMT CDE</title>

  <!-- Librer칤as -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      margin: 20px;
    }

    h1 {
      text-align: center;
      color: #333;
    }

    .input-container {
      text-align: center;
      margin-bottom: 20px;
    }

    input {
      padding: 10px;
      width: 250px;
      margin-right: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    button {
      padding: 10px 15px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    .card {
      background: white;
      padding: 15px;
      margin: 15px auto;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      width: 300px;
      position: relative;
    }

    .card img.logo {
      height: 40px;
      filter: grayscale(100%);
      display: block;
      margin-bottom: 10px;
    }

    .qr-container {
      position: absolute;
      bottom: 10px;
      right: 10px;
    }

    .export-btn {
      margin-top: 10px;
      background: #28a745;
    }

    .export-btn:hover {
      background: #1e7e34;
    }
  </style>
</head>
<body>

<h1>Consulta de Multas - PMT CDE</h1>

<div class="input-container">
  <input type="text" id="matricula" placeholder="Ingrese matr칤cula">
  <button onclick="buscarMatricula()">Buscar</button>
</div>

<div id="resultados"></div>

<script>
  // 游댲 Buscar matr칤cula
  function buscarMatricula() {
    const matricula = document.getElementById("matricula").value.trim().toUpperCase();
    if (!matricula) return;

    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vR1MbRNwg_amqEoZBUn_KT1kuflI2HjY4juQOnLe4X48Hh7LiFUnXmChwO1DEzS0HQ084ZkNcmFudf4/pub?output=csv", {
      download: true,
      header: true,
      complete: function(results) {
        const coincidencias = results.data.filter(r => r.MATRICULA && r.MATRICULA.toUpperCase() === matricula);
        mostrarResultados(coincidencias);
      }
    });
  }

  // 游댲 Mostrar resultados
  function mostrarResultados(lista) {
    const contenedor = document.getElementById("resultados");
    contenedor.innerHTML = "";

    if (lista.length === 0) {
      contenedor.innerHTML = "<p>No se encontraron resultados.</p>";
      return;
    }

    lista.forEach(r => {
      const card = document.createElement("div");
      card.className = "card";

      // Logo
      const logo = document.createElement("img");
      logo.src = "logo.png"; // Reemplazar con tu logo real
      logo.className = "logo";
      card.appendChild(logo);

      // Informaci칩n de la multa
      card.innerHTML += `
        <p><b>Fecha:</b> ${r.FECHA || "N/A"}</p>
        <p><b>Veh칤culo:</b> ${r.VEHICULO || "N/A"}</p>
        <p><b>Matr칤cula:</b> ${r.MATRICULA || "N/A"}</p>
        <p><b>Infracci칩n:</b> ${r.INFRACCION || "N/A"}</p>
        <p><b>Boleta:</b> ${r["BOLETA DE CONTRAVENCION"] || "N/A"}</p>
        <p><b>Comprobante de pago:</b> ${r["COMPROBANTE DE PAGO"] || "Pendiente"}</p>
      `;

      // QR
      const qrDiv = document.createElement("div");
      qrDiv.className = "qr-container";
      card.appendChild(qrDiv);

      const qr = new QRious({
        element: qrDiv,
        value: "#", // se actualizar치 al generar PDF
        size: 80
      });

      // Bot칩n exportar PDF
      const btn = document.createElement("button");
      btn.className = "export-btn";
      btn.textContent = "Exportar PDF";
      btn.onclick = () => exportarPDF(card, r, qr);
      card.appendChild(btn);

      contenedor.appendChild(card);
    });
  }

  // 游댲 Exportar PDF usando html2canvas
  function exportarPDF(card, multa, qr) {
    html2canvas(card).then(canvas => {
      const { jsPDF } = window.jspdf;
      const imgData = canvas.toDataURL("image/png");

      const doc = new jsPDF({
        orientation: "portrait",
        unit: "mm",
        format: [148, 210] // A5
      });

      // Insertar la imagen capturada
      doc.addImage(imgData, "PNG", 10, 10, 128, 180);

      // Crear Blob del PDF y generar URL para el QR
      const pdfBlob = doc.output("blob");
      const pdfURL = URL.createObjectURL(pdfBlob);

      // Actualizar QR para apuntar al PDF
      qr.value = pdfURL;

      // Guardar PDF
      doc.save(`multa_${multa.MATRICULA || "N_A"}.pdf`);
    });
  }

  // 游댲 Permitir buscar con Enter
  document.getElementById("matricula").addEventListener("keypress", function(e){
    if (e.key === "Enter") buscarMatricula();
  });
</script>

</body>
</html>
